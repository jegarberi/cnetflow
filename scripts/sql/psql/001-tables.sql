-- CREATE EXTENSION uint128;
CREATE EXTENSION if not exists pg_cron;
CREATE EXTENSION if not exists timescaledb;



CREATE TABLE IF NOT EXISTS flows
(
    id          bigint generated by default as identity,
    inserted_at timestamp default now() not null,
    exporter    inet,
    srcaddr     inet,
    dstaddr     inet,
    input       integer,
    output      integer,
    dpkts       integer,
    doctets     integer,
    srcport     integer,
    dstport     integer,
    tcp_flags   integer,
    prot        integer,
    tos         integer,
    src_as      integer,
    dst_as      integer,
    src_mask    integer,
    dst_mask    integer,
    ip_version  integer,

    first       timestamp,
    last        timestamp,
    PRIMARY KEY (id, exporter, first)
) WITH (
      timescaledb.hypertable,
      timescaledb.partition_column = 'first',
      timescaledb.segmentby = 'exporter'
      );



create table public.flows_agg_5min
(
    id            bigint generated by default as identity,
    bucket_5min   timestamp not null,
    exporter      inet      not null,
    srcaddr       inet,
    dstaddr       inet,
    input         integer,
    output        integer,
    total_packets bigint,
    total_octets  bigint,
    srcport       integer,
    dstport       integer,
    tcp_flags     integer,
    prot          integer,
    tos           integer,
    src_as        integer,
    dst_as        integer,
    src_mask      integer,
    dst_mask      integer,
    ip_version    integer,
    primary key (id, exporter, bucket_5min),
    constraint flows_agg_5min_unique
        unique (bucket_5min, exporter, srcaddr, dstaddr, srcport, dstport, prot, src_as, dst_as, input, output,
                ip_version, tos)
);

alter table public.flows_agg_5min
    owner to cnetflow;

create index flows_agg_5min_bucket_5min_idx
    on public.flows_agg_5min (bucket_5min desc);

SELECT create_hypertable('flows_agg_5min', 'bucket_5min');
SELECT add_dimension('flows_agg_5min', by_hash('exporter', 10240));
SELECT set_chunk_time_interval('flows', INTERVAL '10 minutes');
SELECT set_chunk_time_interval('flows_agg_5min', INTERVAL '1 hour');


CREATE TABLE IF NOT EXISTS exporters
(
    id                bigint generated by default as identity,
    created_at        timestamp         default now() not null,
    ip_bin            integer  not null default 0,
    ip_inet           inet     not null default '127.0.0.1'::inet,
    name              varchar  not null default '',
    snmp_version      smallint not null default 0,
    snmp_community    varchar  not null default '',
    snmpv3_username   varchar  not null default '',
    snmpv3_level      varchar  not null default '',
    snmpv3_auth_proto varchar  not null default '',
    snmpv3_auth_pass  varchar  not null default '',
    snmpv3_priv_proto varchar  not null default '',
    snmpv3_priv_pass  varchar  not null default '',
    data              json     not null default '{}',
    PRIMARY KEY (id, name, ip_bin, ip_inet)
);
alter table public.exporters
    owner to cnetflow;

CREATE TABLE IF NOT EXISTS interfaces
(
    id          bigint generated by default as identity,
    created_at  timestamp        default now() not null,
    exporter    bigint  not null default 0,
    snmp_index  bigint  not null default 0,
    name        varchar not null default '',
    description varchar not null default '',
    alias       varchar not null default '',
    speed       bigint  not null default 0,
    enabled     boolean not null default true,
    bandwidth   bigint  not null default 0,
    PRIMARY KEY (id, snmp_index, exporter)
);
alter table public.interfaces
    owner to cnetflow;


CREATE TABLE IF NOT EXISTS interface_metrics
(
    inserted_at timestamp       default now() not null,
    id          bigint generated by default as identity,
    exporter    bigint not null default 0,
    snmp_index  bigint not null default 0,
    octets_in   bigint not null default 0,
    octets_out  bigint not null default 0,
    PRIMARY KEY (id, inserted_at, exporter)
);
SELECT create_hypertable('interface_metrics', 'inserted_at');
SELECT add_dimension('interface_metrics', by_hash('exporter', 10240));
SELECT set_chunk_time_interval('interface_metrics', INTERVAL '1 hour');
alter table public.interface_metrics
    owner to cnetflow;


CREATE TABLE IF NOT EXISTS services
(
    id       bigint generated by default as identity,
    addr     cidr,
    port     smallint,
    protocol smallint,
    name     varchar,
    primary key (addr, port, protocol)
);
alter table public.services
    owner to cnetflow;

CREATE TABLE IF NOT EXISTS config
(
    id         bigint generated by default as identity
        primary key,
    created_at timestamp default now() not null,
    key_name   varchar,
    key_value  varchar,
    data       json
);
alter table public.config
    owner to cnetflow;


CREATE TABLE IF NOT EXISTS ports
(
    id          integer default 0 not null,
    number      int               not null,
    protocol    int               not null,
    name        varchar,
    description varchar,
    primary key (number, protocol)
);
alter table public.ports
    owner to cnetflow;



CREATE TABLE IF NOT EXISTS protocols
(
    id          integer default 0 not null,
    name        varchar           not null,
    description varchar           not null,
    primary key (id)
);
alter table public.protocols
    owner to cnetflow;


INSERT INTO ports (number, protocol, name, description)
VALUES (20, 6, 'FTP-DATA',
        'File Transfer Protocol (data). See: https://en.wikipedia.org/wiki/File_Transfer_Protocol'),
       (21, 6, 'FTP',
        'File Transfer Protocol (command/control). See: https://en.wikipedia.org/wiki/File_Transfer_Protocol'),
       (22, 6, 'SSH', 'Secure Shell. See: https://en.wikipedia.org/wiki/Secure_Shell'),
       (23, 6, 'TELNET', 'Telnet protocol. See: https://en.wikipedia.org/wiki/Telnet'),
       (25, 6, 'SMTP',
        'Simple Mail Transfer Protocol. See: https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol'),
       (53, 6, 'DNS',
        'Domain Name System (TCP for zone transfers, queries). See: https://en.wikipedia.org/wiki/Domain_Name_System'),
       (53, 17, 'DNS',
        'Domain Name System (UDP for routine queries). See: https://en.wikipedia.org/wiki/Domain_Name_System'),
       (67, 17, 'DHCP',
        'Dynamic Host Configuration Protocol server. See: https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol'),
       (68, 17, 'DHCP',
        'Dynamic Host Configuration Protocol client. See: https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol'),
       (69, 17, 'TFTP',
        'Trivial File Transfer Protocol. See: https://en.wikipedia.org/wiki/Trivial_File_Transfer_Protocol'),
       (80, 6, 'HTTP',
        'Hypertext Transfer Protocol. See: https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol'),
       (110, 6, 'POP3', 'Post Office Protocol 3. See: https://en.wikipedia.org/wiki/Post_Office_Protocol'),
       (123, 17, 'NTP', 'Network Time Protocol. See: https://en.wikipedia.org/wiki/Network_Time_Protocol'),
       (143, 6, 'IMAP',
        'Internet Message Access Protocol. See: https://en.wikipedia.org/wiki/Internet_Message_Access_Protocol'),
       (161, 17, 'SNMP',
        'Simple Network Management Protocol. See: https://en.wikipedia.org/wiki/Simple_Network_Management_Protocol'),
       (162, 17, 'SNMPTRAP',
        'SNMP Trap. See: https://en.wikipedia.org/wiki/Simple_Network_Management_Protocol#SNMP_traps'),
       (389, 6, 'LDAP',
        'Lightweight Directory Access Protocol. See: https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol'),
       (443, 6, 'HTTPS', 'Hypertext Transfer Protocol Secure. See: https://en.wikipedia.org/wiki/HTTPS'),
       (465, 6, 'SMTPS', 'SMTP Secure (SSL, deprecated). See: https://en.wikipedia.org/wiki/SMTPS'),
       (514, 17, 'SYSLOG', 'Syslog (logging). See: https://en.wikipedia.org/wiki/Syslog'),
       (543, 6, 'KLOGIN', 'Kerberos login. See: https://en.wikipedia.org/wiki/Kerberos_(protocol)'),
       (587, 6, 'SUBMISSION',
        'Mail message submission (SMTP, message submission port). See: https://en.wikipedia.org/wiki/Message_submission_agent'),
       (993, 6, 'IMAPS', 'IMAP over SSL. See: https://en.wikipedia.org/wiki/Internet_Message_Access_Protocol'),
       (995, 6, 'POP3S', 'POP3 over SSL. See: https://en.wikipedia.org/wiki/Post_Office_Protocol'),
       (1080, 6, 'SOCKS', 'SOCKS proxy. See: https://en.wikipedia.org/wiki/SOCKS'),
       (1433, 6, 'MS-SQL-S', 'Microsoft SQL Server. See: https://en.wikipedia.org/wiki/Microsoft_SQL_Server'),
       (2049, 6, 'NFS', 'Network File System. See: https://en.wikipedia.org/wiki/Network_File_System_(protocol)'),
       (2049, 17, 'NFS', 'Network File System. See: https://en.wikipedia.org/wiki/Network_File_System_(protocol)'),
       (3306, 6, 'MYSQL', 'MySQL database. See: https://en.wikipedia.org/wiki/MySQL'),
       (3389, 6, 'RDP', 'Remote Desktop Protocol. See: https://en.wikipedia.org/wiki/Remote_Desktop_Protocol'),
       (5432, 6, 'PostgreSQL', 'PostgreSQL database. See: https://en.wikipedia.org/wiki/PostgreSQL'),
       (5900, 6, 'VNC', 'Virtual Network Computing. See: https://en.wikipedia.org/wiki/Virtual_Network_Computing'),
       (6379, 6, 'Redis', 'Redis key-value store. See: https://en.wikipedia.org/wiki/Redis'),
       (8080, 6, 'HTTP-ALT',
        'Alternative HTTP. See: https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers')
;
INSERT INTO ports (number, protocol, name, description)
VALUES
-- Kerberos (both TCP and UDP)
(88, 6, 'KERBEROS',
 'Kerberos authentication protocol (TCP). See: https://en.wikipedia.org/wiki/Kerberos_(protocol)'),
(88, 17, 'KERBEROS',
 'Kerberos authentication protocol (UDP). See: https://en.wikipedia.org/wiki/Kerberos_(protocol)'),

-- SMB (Server Message Block), often on TCP 445 & legacy NetBIOS on 139
(445, 6, 'SMB', 'Server Message Block. See: https://en.wikipedia.org/wiki/Server_Message_Block'),
(139, 6, 'NETBIOS-SSN', 'NetBIOS Session Service (SMB over NetBIOS). See: https://en.wikipedia.org/wiki/NetBIOS'),


-- Proxy (SOCKS proxy, already included), add HTTP proxy (3128 and 8080 are common)
(3128, 6, 'SQUID-PROXY', 'HTTP proxy (Squid default). See: https://en.wikipedia.org/wiki/Squid_(software)'),

-- Elastic (Elasticsearch HTTP API)
(9200, 6, 'ELASTICSEARCH',
 'Elasticsearch HTTP API. See: https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html'),
(9300, 6, 'ES-CLUSTER',
 'Elasticsearch internal cluster communication. See: https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-transport.html'),

-- NetFlow (UDP, traditionally 2055, 9555, 9995, 4739 for IPFIX)
(2055, 17, 'NETFLOW', 'NetFlow data export. See: https://en.wikipedia.org/wiki/NetFlow'),
(4739, 17, 'IPFIX',
 'IPFIX data export (NetFlow v10). See: https://en.wikipedia.org/wiki/IP_Flow_Information_Export'),
(9995, 17, 'NETFLOW',
 'NetFlow alternative port. See: https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers#Well-known_ports'),
(9555, 17, 'NETFLOW',
 'NetFlow v9 alternative port. See: https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers#Well-known_ports'),

-- SIP (Session Initiation Protocol, commonly on 5060 UDP/TCP, and 5061 for TLS)
(5060, 6, 'SIP', 'SIP signaling (TCP). See: https://en.wikipedia.org/wiki/Session_Initiation_Protocol'),
(5060, 17, 'SIP', 'SIP signaling (UDP). See: https://en.wikipedia.org/wiki/Session_Initiation_Protocol'),
(5061, 6, 'SIPS', 'SIP over TLS (TCP). See: https://en.wikipedia.org/wiki/Session_Initiation_Protocol'),
(5061, 17, 'SIPS', 'SIP over TLS (UDP, rare). See: https://en.wikipedia.org/wiki/Session_Initiation_Protocol')
;
INSERT INTO public.protocols(id, name, description)
VALUES (0, 'HOPOPT', 'IPv6 Hop-by-Hop Option. See: https://en.wikipedia.org/wiki/IPv6_packet#IPv6_Hop-by-Hop_Option'),
       (1, 'ICMP',
        'Internet Control Message Protocol. See: https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol'),
       (2, 'IGMP',
        'Internet Group Management Protocol. See: https://en.wikipedia.org/wiki/Internet_Group_Management_Protocol'),
       (3, 'GGP', 'Gateway-to-Gateway Protocol. See: https://en.wikipedia.org/wiki/Gateway-to-Gateway_Protocol'),
       (4, 'IPv4', 'IPv4 encapsulation. See: https://en.wikipedia.org/wiki/IPv4'),
       (5, 'ST', 'Stream Protocol. See: https://en.wikipedia.org/wiki/Stream_(protocol)'),
       (6, 'TCP', 'Transmission Control Protocol. See: https://en.wikipedia.org/wiki/Transmission_Control_Protocol'),
       (7, 'CBT', 'CBT. See: https://en.wikipedia.org/wiki/Core-based_trees'),
       (8, 'EGP', 'Exterior Gateway Protocol. See: https://en.wikipedia.org/wiki/Exterior_Gateway_Protocol'),
       (9, 'IGP', 'Interior Gateway Protocol. See: https://en.wikipedia.org/wiki/Interior_gateway_protocol'),
       (10, 'BBN-RCC-MON', 'BBN RCC Monitoring. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (11, 'NVP-II', 'Network Voice Protocol. See: https://en.wikipedia.org/wiki/Network_Voice_Protocol'),
       (12, 'PUP', 'PARC Universal Packet. See: https://en.wikipedia.org/wiki/PARC_Universal_Packet'),
       (13, 'ARGUS', 'ARGUS. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (14, 'EMCON', 'EMCON. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (15, 'XNET', 'Cross Net Debugger. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (16, 'CHAOS', 'Chaos. See: https://en.wikipedia.org/wiki/Chaosnet'),
       (17, 'UDP', 'User Datagram Protocol. See: https://en.wikipedia.org/wiki/User_Datagram_Protocol'),
       (18, 'MUX', 'Multiplexing. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (19, 'DCN-MEAS', 'DCN Measurement Subsystems. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (20, 'HMP', 'Host Monitoring Protocol. See: https://en.wikipedia.org/wiki/Host_Monitoring_Protocol'),
       (21, 'PRM', 'Packet Radio Measurement. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (22, 'XNS-IDP', 'Xerox NS IDP. See: https://en.wikipedia.org/wiki/Xerox_Network_Systems'),
       (23, 'TRUNK-1', 'Trunk-1. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (24, 'TRUNK-2', 'Trunk-2. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (25, 'LEAF-1', 'Leaf-1. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (26, 'LEAF-2', 'Leaf-2. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (27, 'RDP', 'Reliable Data Protocol. See: https://en.wikipedia.org/wiki/Reliable_Data_Protocol'),
       (28, 'IRTP',
        'Internet Reliable Transaction Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (29, 'ISO-TP4', 'ISO Transport Protocol Class 4. See: https://en.wikipedia.org/wiki/Transport_Protocol'),
       (30, 'NETBLT', 'Network Block Transfer. See: https://en.wikipedia.org/wiki/NETBLT'),
       (31, 'MFE-NSP', 'MFE Network Services Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (32, 'MERIT-INP', 'MERIT Internodal Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (33, 'DCCP',
        'Datagram Congestion Control Protocol. See: https://en.wikipedia.org/wiki/Datagram_Congestion_Control_Protocol'),
       (34, '3PC', 'Third Party Connect Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (35, 'IDPR', 'Inter-Domain Policy Routing Protocol. See: https://en.wikipedia.org/wiki/IDPR'),
       (36, 'XTP', 'Xpress Transfer Protocol. See: https://en.wikipedia.org/wiki/Xpress_Transfer_Protocol'),
       (37, 'DDP', 'Datagram Delivery Protocol. See: https://en.wikipedia.org/wiki/Datagram_Delivery_Protocol'),
       (38, 'IDPR-CMTP',
        'IDPR Control Message Transport. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (39, 'TP++', 'TP++ Transport Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (40, 'IL', 'IL Transport Protocol. See: https://en.wikipedia.org/wiki/IL_protocol'),
       (41, 'IPv6', 'Internet Protocol version 6. See: https://en.wikipedia.org/wiki/IPv6'),
       (42, 'SDRP',
        'Source Demand Routing Protocol. See: https://en.wikipedia.org/wiki/Source_demand_routing_protocol'),
       (43, 'IPv6-Route', 'Routing Header for IPv6. See: https://en.wikipedia.org/wiki/IPv6_packet#Routing'),
       (44, 'IPv6-Frag', 'Fragment Header for IPv6. See: https://en.wikipedia.org/wiki/IPv6_packet#Fragment'),
       (45, 'IDRP', 'Inter-Domain Routing Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (46, 'RSVP', 'Resource Reservation Protocol. See: https://en.wikipedia.org/wiki/Resource_Reservation_Protocol'),
       (47, 'GRE', 'Generic Routing Encapsulation. See: https://en.wikipedia.org/wiki/Generic_Routing_Encapsulation'),
       (48, 'DSR', 'Dynamic Source Routing Protocol. See: https://en.wikipedia.org/wiki/Dynamic_Source_Routing'),
       (49, 'BNA', 'BNA. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (50, 'ESP', 'Encap Security Payload. See: https://en.wikipedia.org/wiki/IPsec'),
       (51, 'AH', 'Authentication Header. See: https://en.wikipedia.org/wiki/IPsec'),
       (52, 'I-NLSP',
        'Integrated Net Layer Security Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (53, 'SWIPE', 'SWIPE. See: https://en.wikipedia.org/wiki/SWIPE_(IPsec)'),
       (54, 'NARP',
        'NBMA Address Resolution Protocol. See: https://en.wikipedia.org/wiki/NBMA_Address_Resolution_Protocol'),
       (55, 'MOBILE', 'IP Mobility. See: https://en.wikipedia.org/wiki/Mobile_IP'),
       (56, 'TLSP',
        'Transport Layer Security Protocol using Kryptonet keys. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (57, 'SKIP', 'SKIP. See: https://en.wikipedia.org/wiki/Simple_Key-Management_for_Internet_Protocol'),
       (58, 'IPv6-ICMP', 'ICMP for IPv6. See: https://en.wikipedia.org/wiki/ICMPv6'),
       (59, 'IPv6-NoNxt', 'No Next Header for IPv6. See: https://en.wikipedia.org/wiki/IPv6_packet#No_Next_Header'),
       (60, 'IPv6-Opts',
        'Destination Options for IPv6. See: https://en.wikipedia.org/wiki/IPv6_packet#Destination_Options'),
       (61, 'Any host internal protocol',
        'Any host internal protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (62, 'CFTP', 'CFTP. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (63, 'Any local network', 'Any local network. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (64, 'SAT-EXPAK', 'SATNET and Backroom EXPAK. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (65, 'KRYPTOLAN', 'Kryptolan. See: https://en.wikipedia.org/wiki/Kryptolan'),
       (66, 'RVD', 'MIT Remote Virtual Disk Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (67, 'IPPC', 'Internet Pluribus Packet Core. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (68, 'Any distributed file system',
        'Any distributed file system. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (69, 'SAT-MON', 'SATNET Monitoring. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (70, 'VISA', 'VISA Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (71, 'IPCV', 'Internet Packet Core Utility. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (72, 'CPNX',
        'Computer Protocol Network Executive. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (73, 'CPHB', 'Computer Protocol Heart Beat. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (74, 'WSN', 'Wang Span Network. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (75, 'PVP', 'Packet Video Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (76, 'BR-SAT-MON', 'Backroom SATNET Monitoring. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (77, 'SUN-ND', 'SUN ND Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (78, 'WB-MON', 'WIDEBAND Monitoring. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (79, 'WB-EXPAK', 'WIDEBAND EXPAK. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (80, 'ISO-IP', 'ISO Internet Protocol. See: https://en.wikipedia.org/wiki/Connectionless_Network_Protocol'),
       (81, 'VMTP',
        'Versatile Message Transaction Protocol. See: https://en.wikipedia.org/wiki/Versatile_Message_Transaction_Protocol'),
       (82, 'SECURE-VMTP', 'SECURE-VMTP. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (83, 'VINES', 'VINES. See: https://en.wikipedia.org/wiki/Banyan_VINES'),
       (84, 'TTP', 'TTP. See: https://en.wikipedia.org/wiki/Transport_triggered_architecture'),
       (85, 'NSFNET-IGP', 'NSFNET-IGP. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (86, 'DGP', 'Dissimilar Gateway Protocol. See: https://en.wikipedia.org/wiki/Dissimilar_gateway_protocol'),
       (87, 'TCF', 'TCF. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (88, 'EIGRP',
        'Enhanced Interior Gateway Routing Protocol. See: https://en.wikipedia.org/wiki/Enhanced_Interior_Gateway_Routing_Protocol'),
       (89, 'OSPFIGP', 'Open Shortest Path First. See: https://en.wikipedia.org/wiki/Open_Shortest_Path_First'),
       (90, 'Sprite-RPC', 'Sprite RPC Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (91, 'LARP',
        'Locus Address Resolution Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (92, 'MTP', 'Multicast Transport Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (93, 'AX.25', 'AX.25 Frames. See: https://en.wikipedia.org/wiki/AX.25'),
       (94, 'IPIP', 'IP-within-IP Encapsulation Protocol. See: https://en.wikipedia.org/wiki/IP_in_IP'),
       (95, 'MICP',
        'Mobile Internetworking Control Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (96, 'SCC-SP',
        'Semaphore Communications Security Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (97, 'ETHERIP', 'Ethernet-within-IP Encapsulation. See: https://en.wikipedia.org/wiki/EtherIP'),
       (98, 'ENCAP', 'Encapsulation Header. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (99, 'Any private encryption scheme',
        'Any private encryption scheme. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (100, 'GMTP', 'GMTP. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (101, 'IFMP',
        'Ipsilon Flow Management Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (102, 'PNNI', 'PNNI over IP. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (103, 'PIM',
        'Protocol Independent Multicast. See: https://en.wikipedia.org/wiki/Protocol_Independent_Multicast'),
       (104, 'ARIS', 'ARIS. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (105, 'SCPS', 'SCPS. See: https://en.wikipedia.org/wiki/Space_Communications_Protocol_Specification'),
       (106, 'QNX', 'QNX. See: https://en.wikipedia.org/wiki/QNX'),
       (107, 'A/N', 'Active Networks. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (108, 'IPComp',
        'IP Payload Compression Protocol. See: https://en.wikipedia.org/wiki/IP_Payload_Compression_Protocol'),
       (109, 'SNP', 'Sitara Networks Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (110, 'Compaq-Peer', 'Compaq Peer Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (111, 'IPX-in-IP', 'IPX in IP. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (112, 'VRRP',
        'Virtual Router Redundancy Protocol. See: https://en.wikipedia.org/wiki/Virtual_Router_Redundancy_Protocol'),
       (113, 'PGM', 'Pragmatic General Multicast. See: https://en.wikipedia.org/wiki/Pragmatic_General_Multicast'),
       (114, 'Any 0-hop protocol',
        'Any 0-hop protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (115, 'L2TP', 'Layer Two Tunneling Protocol. See: https://en.wikipedia.org/wiki/Layer_2_Tunneling_Protocol'),
       (116, 'DDX', 'D-II Data Exchange. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (117, 'IATP',
        'Interactive Agent Transfer Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (118, 'STP', 'Schedule Transfer Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (119, 'SRP', 'SpectraLink Radio Protocol. See: https://en.wikipedia.org/wiki/SpectraLink_Radio_Protocol'),
       (120, 'UTI', 'UTI. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (121, 'SMP', 'Simple Message Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (122, 'SM', 'Simple Multicast Protocol. See: https://en.wikipedia.org/wiki/Simple_Multicast_Protocol'),
       (123, 'PTP',
        'Performance Transparency Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (124, 'ISIS over IPv4', 'ISIS over IPv4. See: https://en.wikipedia.org/wiki/IS-IS_(routing_protocol)'),
       (125, 'FIRE', 'FIRE. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (126, 'CRTP', 'Combat Radio Transport Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (127, 'CRUDP',
        'Combat Radio User Datagram Protocol. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (128, 'SSCOPMCE', 'SSCOPMCE. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (129, 'IPLT', 'IPLT. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (130, 'SPS', 'Secure Packet Shield. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (131, 'PIPE',
        'Private IP Encapsulation within IP. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (132, 'SCTP',
        'Stream Control Transmission Protocol. See: https://en.wikipedia.org/wiki/Stream_Control_Transmission_Protocol'),
       (133, 'FC', 'Fibre Channel. See: https://en.wikipedia.org/wiki/Fibre_Channel'),
       (134, 'RSVP-E2E-IGNORE', 'RSVP E2E Ignore. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (135, 'Mobility Header', 'Mobility Header for IPv6. See: https://en.wikipedia.org/wiki/Mobility_header'),
       (136, 'UDPLite', 'Lightweight User Datagram Protocol. See: https://en.wikipedia.org/wiki/UDP-Lite'),
       (137, 'MPLS-in-IP', 'MPLS-in-IP. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (138, 'manet', 'MANET Protocols. See: https://en.wikipedia.org/wiki/Mobile_ad_hoc_network'),
       (139, 'HIP', 'Host Identity Protocol. See: https://en.wikipedia.org/wiki/Host_Identity_Protocol'),
       (140, 'Shim6', 'Shim6 Protocol. See: https://en.wikipedia.org/wiki/SHIM6'),
       (141, 'WESP', 'Wrapped Encapsulating Security Payload. See: https://en.wikipedia.org/wiki/WESP'),
       (142, 'ROHC', 'Robust Header Compression. See: https://en.wikipedia.org/wiki/Robust_Header_Compression'),
       (143, 'Ethernet', 'Ethernet. See: https://en.wikipedia.org/wiki/Ethernet'),
       (253, 'Use for experimentation and testing',
        'Use for experimentation and testing. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (254, 'Use for experimentation and testing',
        'Use for experimentation and testing. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers'),
       (255, 'Reserved', 'Reserved. See: https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers');


-- Amazon AWS EC2, S3, ELB (example, see AWS ip-ranges.json for full)
INSERT INTO services (addr, port, protocol, name)
VALUES ('13.32.0.0/15', 443, 6, 'aws-cloudfront-https'),
       ('52.95.110.0/24', 443, 6, 'aws-s3-https'),
       ('3.5.140.0/22', 443, 6, 'aws-ap-southeast-2-https'),
       ('52.95.245.0/24', 443, 6, 'aws-s3-https'),
       ('205.251.192.0/19', 53, 17, 'aws-route53-udp'),
       ('205.251.192.0/19', 53, 6, 'aws-route53-tcp');

-- Google Cloud Platform (GCP), Google Public DNS, Google APIs
INSERT INTO services (addr, port, protocol, name)
VALUES ('8.8.8.0/24', 53, 17, 'google-public-dns-udp'),
       ('8.8.4.0/24', 53, 17, 'google-public-dns-udp'),
       ('8.8.8.0/24', 53, 6, 'google-public-dns-tcp'),
       ('8.8.4.0/24', 53, 6, 'google-public-dns-tcp'),
       ('64.233.160.0/19', 443, 6, 'google-cloud-https'),
       ('66.102.0.0/20', 443, 6, 'google-https'),
       ('172.217.0.0/16', 443, 6, 'google-https'),
       ('108.177.8.0/21', 443, 6, 'google-mail-https');

-- Netflix OpenConnect CDN (taken from official list)
INSERT INTO services (addr, port, protocol, name)
VALUES ('52.46.0.0/18', 443, 6, 'netflix-cdn-https'),
       ('69.53.224.0/19', 443, 6, 'netflix-cdn-https'),
       ('198.38.96.0/19', 443, 6, 'netflix-cdn-https'),
       ('198.45.48.0/20', 443, 6, 'netflix-cdn-https'),
       ('103.87.204.0/22', 443, 6, 'netflix-cdn-https');

-- Akamai (very large, example only)
INSERT INTO services (addr, port, protocol, name)
VALUES ('23.32.0.0/11', 443, 6, 'akamai-cdn-https'),
       ('23.32.0.0/11', 80, 6, 'akamai-cdn-http');

-- Cloudflare (more at https://www.cloudflare.com/ips/)
INSERT INTO services (addr, port, protocol, name)
VALUES ('104.16.0.0/12', 443, 6, 'cloudflare-https'),
       ('104.16.0.0/12', 80, 6, 'cloudflare-http'),
       ('172.64.0.0/13', 443, 6, 'cloudflare-https'),
       ('172.64.0.0/13', 80, 6, 'cloudflare-http');

-- Fastly CDN (see https://api.fastly.com/public-ip-list)
INSERT INTO services (addr, port, protocol, name)
VALUES ('151.101.0.0/16', 443, 6, 'fastly-cdn-https'),
       ('151.101.0.0/16', 80, 6, 'fastly-cdn-http');

-- Limelight (Edgio) CDN
INSERT INTO services (addr, port, protocol, name)
VALUES ('68.142.64.0/18', 443, 6, 'edgio-limelight-cdn-https'),
       ('68.142.64.0/18', 80, 6, 'edgio-limelight-cdn-http');

-- Meta/Facebook Caches (edge example)
INSERT INTO services (addr, port, protocol, name)
VALUES ('157.240.0.0/16', 443, 6, 'facebook-meta-https');

-- Microsoft Azure / CDN (example subnets)
INSERT INTO services (addr, port, protocol, name)
VALUES ('13.107.128.0/22', 443, 6, 'azure-cdn-https'),
       ('13.107.136.0/22', 443, 6, 'azure-cdn-https');

-- Apple (example)
INSERT INTO services (addr, port, protocol, name)
VALUES ('17.0.0.0/8', 443, 6, 'apple-services-https');

-- General: NetFlow collectors on AWS, Google, CDNs (example: NetFlow-over-UDP)
INSERT INTO services (addr, port, protocol, name)
VALUES ('13.32.0.0/15', 2055, 17, 'aws-netflow-udp'),
       ('104.16.0.0/12', 2055, 17, 'cloudflare-netflow-udp'),
       ('151.101.0.0/16', 2055, 17, 'fastly-netflow-udp');

create role web_anon nologin;
grant usage on schema public to web_anon;
grant select on public.exporters to web_anon;
grant select on public.flows to web_anon;
grant select on public.flows_agg_5min to web_anon;
grant select on public.config to web_anon;
grant select on public.interface_metrics to web_anon;
grant select on public.services to web_anon;
grant select on public.interfaces to web_anon;
ALTER DATABASE postgres SET timezone TO 'America/Argentina/Buenos_Aires';

