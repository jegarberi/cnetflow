cmake_minimum_required(VERSION 3.25)
project(cnetflow C)

SET (CMAKE_C_COMPILER             "/usr/bin/gcc")
#SET (CMAKE_C_COMPILER             "/usr/bin/clang")
SET (CMAKE_C_FLAGS_DEBUG          "-g -Wall -Wextra -pedantic ")
SET (CMAKE_C_FLAGS_MINSIZEREL     "-Os -DNDEBUG -Wall -Wextra -pedantic")
SET (CMAKE_C_FLAGS_RELEASE        "-O4 -DNDEBUG -Wall -Wextra -pedantic")
#SET (CMAKE_C_FLAGS_RELWITHDEBINFO "-O2 -g -Wall -Wextra -pedantic")
set(CMAKE_INTERPROCEDURAL_OPTIMIZATION TRUE)
set(CMAKE_INCLUDE_PATH "/usr/include/postgresql/15/server/libpq/")
option(BUILD__LIBS "Build shared libraries" ON)
set(CMAKE_C_STANDARD 99)
install(FILES cnetflow.service DESTINATION /lib/systemd/system/)
install(FILES cnetflow.conf DESTINATION /etc/systemd/system/cnetflow.service.d/)
#install(TARGETS RUNTIME DESTINATION /usr/local/cnetflow/ PERMISSIONS OWNER_WRITE OWNER_READ OWNER_EXECUTE GROUP_READ WORLD_EXECUTE WORLD_READ)
install(TARGETS RUNTIME DESTINATION /usr/local/cnetflow/)
install(TARGETS LIBRARY DESTINATION /usr/local/cnetflow/)

#install(FILES *.so DESTINATION /usr/local/cnetflow/)
add_executable(cnetflow src/main.c)
add_library(collector       src/collector.c)
add_library(arena           src/arena.c)
add_library(snmp            src/snmp.c)
add_library(dyn_array       src/dyn_array.c)
add_library(db_psql         src/db_psql.c)
add_library(netflow         src/netflow.c)
add_library(netflow_v5      src/netflow_v5.c)
add_library(netflow_v9      src/netflow_v9.c)
add_library(netflow_ipfix   src/netflow_ipfix.c)
add_library(hashmap         src/hashmap.c)


target_link_libraries(netflow_v9 db_psql)
target_link_libraries(netflow_v5 db_psql)

target_link_libraries(collector uv arena hashmap netflow netflow_ipfix netflow_v5 netflow_v9 db_psql pq snmp dyn_array)
target_link_libraries(cnetflow uv netflow netflow_ipfix netflow_v5 netflow_v9 arena hashmap collector db_psql pq snmp dyn_array)